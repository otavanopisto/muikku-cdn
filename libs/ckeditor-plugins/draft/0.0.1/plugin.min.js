/*! CKEditor plugin coops - v0.0.1 - 2016-04-25
* https://github.com/otavanopisto/ckeditor-draft
* Copyright (c) 2016 ; Licensed LGPL-v3 */
(function(){"use strict";function a(a){var b=new jsSHA("SHA-512","TEXT");return b.update(a),b.getHash("HEX")}function b(a){return(a.getData()||"").replace(/\n/g,"")}function c(c){return a(b(c))}function d(a,b){a?(new JSZip).file("draft",a).generateAsync({type:"string"}).then(function(a){b(null,a)}):b(null,null)}function e(a,b){a?(new JSZip).loadAsync(a).then(function(a){try{var c=a.file("draft");c?c.async("string").then(function(a){b(null,a)}):b("Invalid zip file")}catch(d){b(d,null)}}):b(null,null)}function f(a,b){var c=a.lang.draft,d=new h(a,{text:'<div class="draft-cancel"><span class="draft-label">'+c.draftRestoredLabel+'</span><span class="draft-text">'+c.draftRestoredText+"</span>{cancel}</div>",links:[{id:"cancel",text:c.restoreDraft,click:function(){a.setData(b),d.hide()}}]});d.show()}function g(a){var b=a.lang.draft,c=new h(a,{text:'<div class="draft-restore"><span class="draft-label">'+b.restoreDraftLabel+'</span><span class="draft-text">'+b.restoreDraftText+"</span>{load}</div>",links:[{id:"load",text:b.restoreDraft,click:CKEDITOR.tools.bind(function(){e(this.getDraftData(),CKEDITOR.tools.bind(function(a,b){if(a)alert("Draft restore failed");else{var d=this.getData();this.setData(b),this.discardDraft(!0),f(this,d),c.hide()}},this))},a)}]});c.show()}var h=null;CKEDITOR.plugins.add("draft",{requires:["notification","change"],lang:"fi,en",init:function(e){return window.localStorage?window.jsSHA?window.JSZip?(h=CKEDITOR.tools.createClass({base:CKEDITOR.plugins.notification,$:function(a,b){var c=b.text;if(b.links)for(var d=0,e=b.links.length;e>d;d++){var f=b.links[d],g=CKEDITOR.tools.addFunction(f.click),h='<a href="javascript:CKEDITOR.tools.callFunction('+g+')">'+f.text+"</a>";c=c.replace("{"+f.id+"}",h)}this.base(a,{duration:6e4,message:c})}}),e.on("instanceReady",function(a){a.editor._originalContentHash=c(a.editor);var b=a.editor.getDraftTime();b&&g(e),e.on("contentChange",function(a){a.editor._draftStoreTimeout&&clearTimeout(a.editor._draftStoreTimeout),a.editor._draftStoreTimeout=CKEDITOR.tools.setTimeout(function(){this.storeDraft()},1e3,a.editor)})}),e.getDraftTime=CKEDITOR.tools.bind(function(){return localStorage.getItem(this.config.draftKey+".time")},e),e.getDraftHash=CKEDITOR.tools.bind(function(){return localStorage.getItem(this.config.draftKey+".hash")},e),e.getDraftData=CKEDITOR.tools.bind(function(){return localStorage.getItem(this.config.draftKey+".data")},e),e.storeDraft=CKEDITOR.tools.bind(function(){var c=b(this),e=a(c);this._originalContentHash!=e?d(c,CKEDITOR.tools.bind(function(a,b){a?window.console&&console.error(a):(localStorage.setItem(this.config.draftKey+".time",(new Date).getTime()),localStorage.setItem(this.config.draftKey+".hash",e),localStorage.setItem(this.config.draftKey+".data",b))},this)):this.discardDraft()},e),void(e.discardDraft=CKEDITOR.tools.bind(function(a){localStorage.removeItem(this.config.draftKey+".time"),localStorage.removeItem(this.config.draftKey+".hash"),localStorage.removeItem(this.config.draftKey+".data"),a&&(this._originalContentHash=c(this))},e))):void(window.console&&console.error("Could not initialize draft plugin, because JSZip is not loaded")):void(window.console&&console.error("Could not initialize draft plugin, because jsSHA is not loaded")):void(window.console&&console.error("Could not initialize draft plugin, because localStorage is not supported"))}})}).call(this),CKEDITOR.plugins.setLang("draft","en",{restoreDraftLabel:"More recent draft of this document exsits",restoreDraftText:"load draft by clicking",restoreDraft:"here",draftRestoredLabel:"Draft restored",draftRestoredText:"you may cancel this by clicking",draftCancel:"here"}),CKEDITOR.plugins.setLang("draft","fi",{restoreDraftLabel:"Dokumentista on olemassa uudempi vedos",restoreDraftText:"lataa vedos klikkaamalla",restoreDraft:"tästä",draftRestoredLabel:"Vedos palautettu",draftRestoredText:"Voit palauttaa alkuperäisen sisällön klikkaamalla",draftCancel:"tästä"});